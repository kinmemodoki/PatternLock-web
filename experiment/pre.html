<!DOCTYPE html>
<html>
<head>
  <title>実験調査のお願い</title>
  <meta name="viewport" content="width=640">
  <meta charset="UTF-8">
  <link href="/stylesheets/bootstrap.min.css"  rel="stylesheet" type="text/css" />
  <link href="/stylesheets/main.css"  rel="stylesheet" type="text/css" />
  <link href="./style.css"  rel="stylesheet" type="text/css" />
</head>
<body>
  <div class="title dottext">実験準備</div> 
  <div class="section">
    <div class="topic">アンケート</div>
    <div>・職業を教えてください</div>
    <form class="sample" id="education">
      <input type="radio" name="edu" id="select1" value="0">
      <label for="select1" class="oneline">大学生</label>
      <input type="radio" name="edu" id="select2" value="1">
      <label for="select2" class="oneline">大学院生</label>
      <input type="radio" name="edu" id="select3" value="2">
      <label for="select3">社会人<br>(学部卒)</label>
      <input type="radio" name="edu" id="select4" value="3">
      <label for="select4">社会人<br>(院卒以上)</label>
      <input type="radio" name="edu" id="select5" value="4">
      <label for="select5" class="oneline">高校生</label>
    </form>
    <div>・大学でセキュリティ専攻していますか？</div>
    <form class="sample" id="isSec">
      <input type="radio" name="sec" id="select00" value="specialist">
      <label for="select00" class="oneline">はい</label>
      <input type="radio" name="sec" id="select01" value="nonspecialist">
      <label for="select01" class="oneline">いいえ</label>
    </form>

    <div class="topic">通知設定</div>
    LINEbot友達登録 or PUSH通知許可してね！<br>
    iOSはPUSH通知を設定できません><
    <div class="sample">
      <input type="button" name="edu" id="push">
      <label id="pushBtn" for="push" class="oneline btn" onclick="requestPermission()">PUSH通知を許可</label>
      <label href="" id="pushBtn" for="line" class="oneline btn" onclick="line()">LINEbot友達登録</label>
      
    </div>
    希望ID設定
    <div><input type="text" id="text" placeholder="空白でも可"></div>
      
    </div>

    <br>
    <br>
    <div class="sample">
      <input type="button" name="edu">
      <label for="push" class="oneline btn" onclick="sendData()">設定完了</label>
    </div>

  </div>

  <div id="load-container">
    <div class="loader"></div>
    つうしんちゅう...
  </div>
</body>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
<script type="text/javascript" src="/scripts/cookies.js"></script>
<script type="text/javascript">
function line() {
  window.open('https://line.me/R/ti/p/-fqe4ImbNv', '_blank');
}
  
// get Cookie data
var context = getUserData();  
var user = context.player ? JSON.parse(context.player) : {};

// Initialize Firebase
var config = {
  apiKey: "AIzaSyDS8ZSgmRIWZ6fEZCIIWiXCG4OjbMlSp1M",
  authDomain: "css-pre-exp.firebaseapp.com",
  databaseURL: "https://css-pre-exp.firebaseio.com",
  projectId: "css-pre-exp",
  messagingSenderId: "842556271550"
};
firebase.initializeApp(config);

const messaging = firebase.messaging();
console.log(messaging); 

function fetchToken() {
  messaging.getToken()
  .then(function(currentToken) {
    if (currentToken) {
      console.log(currentToken);
      updateUI(currentToken);
    } else {
      //firebaseのprojectが死んどるぞ
      console.log('No Instance ID token available. Request permission to generate one.');
    }
  })
  .catch(function(err) {
    console.log('An error occurred while retrieving token. ', err);
  });
}

/*messaging.getToken()
.then(function(currentToken) {
  alert(currentToken);
});*/

function requestPermission() {
  console.log('Requesting permission...');
  messaging.requestPermission()
  .then(function() {
    console.log('Notification permission granted.');
    fetchToken();
  })
  .catch(function(err) {
    console.log('Unable to get permission to notify.', err);
  });
  // [END request_permission]
}

function updateUI(currentToken) {
  // Show token in console and UI.
  var btn = document.getElementById("pushBtn");
  btn.classList.add('pushed');
  btn.innerText = "許可されました"
}

function create_privateid( n ){
  var CODE_TABLE = "0123456789"
      + "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
      + "abcdefghijklmnopqrstuvwxyz";
  var r = "";
  for (var i = 0, k = CODE_TABLE.length; i < n; i++){
      r += CODE_TABLE.charAt(Math.floor(k * Math.random()));
  }
  r = document.getElementById("text").value + r;
  return r;
}

async function sendData(){
  try{
    document.getElementById("load-container").style.display = "block";
    //user.id設定
    if(!user.id){
      user.id = create_privateid(24);
    }

    //グループ取得
    var isSpec = document.getElementById("isSec").sec.value;
    var education = document.getElementById("education").edu.value;
    var specialist = isSpec=="specialist" ? 1 : 0;
    if(!isSpec)
      throw new Error("アンケートが選択されてないよ");
    var res = await fetch("/log/user/"+isSpec)
    .then(response => {
      return response.text();
    });
    if(!res){
      //if(!window.confirm("サーバ接続失敗．\n実験を記録せずにつづけますか？")){
        //throw new Error("実験グループ取得失敗\nすみません！サーバエラーです...");
      //}
    }

    if(res%2==0){
      var group = "a";
    }else{
      var group = "b";
    }

    //token取得
    var myToken = await messaging.getToken();
    if(myToken){
      await firebase.database().ref('push/'+myToken).set({userId: myToken});
    }


    //送信処理
    console.log("username="+user.id+"&edu="+education+"&specialist="+specialist+"&group="+group+"&pid="+myToken);

    await fetch("/log/user", {
      method: 'POST',
      body: new URLSearchParams("username="+user.id+"&edu="+user.key+"&specialist="+specialist+"&group="+group+"&pid="+myToken)
    }).then((res,err)=>{
      console.log(res.status);
    });

    //ページ遷移
    if(group=="a"){
      user.group = "a";
      docCookies.setItem("player",JSON.stringify(user));
    }else if(group=="b"){
      user.group = "b";
      docCookies.setItem("player",JSON.stringify(user));
    }
    window.location = "redirect.html?status=Desc&term=1"
  } catch(err){
    alert(err);
    document.getElementById("load-container").style.display = "none";
  }
}
</script>
</html>